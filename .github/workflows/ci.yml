name: CI

on:
  push:
    branches: [main, feature/contracts, feature/frontend]
  pull_request:
    branches: [main]

jobs:
  contracts:
    name: Contracts (Foundry)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable
          cache: true

      - name: Build
        run: cd contracts && forge build --sizes

      - name: Test
        run: cd contracts && forge test -vvv

  frontend:
    name: Frontend (Next.js)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "store=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.store }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: cd frontend && pnpm install --frozen-lockfile

      - name: Type check
        run: cd frontend && pnpm tsc --noEmit

      - name: Build
        run: cd frontend && pnpm build
        env:
          NEXT_PUBLIC_OG_NFT_ADDRESS: "0x0000000000000000000000000000000000000000"
          NEXT_PUBLIC_OG_MARKETPLACE_ADDRESS: "0x0000000000000000000000000000000000000000"
          NEXT_PUBLIC_ADI_PAYMENT_ADDRESS: "0x0000000000000000000000000000000000000000"

  agents:
    name: Agents (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('agents/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: cd agents && pip install -r requirements.txt

      - name: Check imports
        run: cd agents && python -c "import api; print('FastAPI app OK')"

      - name: Type check (mypy)
        run: cd agents && mypy . --ignore-missing-imports
        continue-on-error: true
